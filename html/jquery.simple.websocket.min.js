!function(a){"object"==typeof module&&"object"==typeof module.exports?module.exports=a(require("jquery")):a(jQuery)}(function(a){var b=function(b){if(this._opt=null,!this._isNotEmpty(b,"url"))throw new Error("Missing argument, example usage: $.simpleWebSocket({ url: 'ws://127.0.0.1:3000' }); ");this._opt=b,this._ws=null,this._reConnectTries=60,this._reConnectDeferred=null,this._listeners=[];var c=this;return this._api=function(){return{connect:function(){return a.extend(c._api,c._reConnect.apply(c,[]))},isConnected:function(a){return a?(a.apply(this,[c._isConnected.apply(c,[])]),c._api):c._isConnected.apply(c,[])},send:function(b){return a.extend(c._api,c._send.apply(c,[b]))},listen:function(b){return a.extend(c._api,c._listenReconnect.apply(c,[b]))},remove:function(a){return c._remove.apply(c,[a]),c._api},removeAll:function(){return c._listeners=[],c._api},close:function(){return c._close.apply(c,[]),c._api}}}(),this._api};b.prototype={_webSocket:function(b){var c;if(c=b.protocols?"undefined"!=typeof window.MozWebSocket?new MozWebSocket(b.url,b.protocols):window.WebSocket?new WebSocket(b.url,b.protocols):null:"undefined"!=typeof window.MozWebSocket?new MozWebSocket(b.url):window.WebSocket?new WebSocket(b.url):null,!c)throw new Error("Error, websocket could not be initialized.");return a(c).bind("open",b.open).bind("close",b.close).bind("message",function(c){var d=a.evalJSON(c.originalEvent.data);b[c.type]&&b[c.type].call(this,d)}).bind("error",function(a){b.error&&b.error.call(this,a)}),c},_connect:function(){var b=this,c=a.Deferred();if(this._ws)if(2===this._ws.readyState||3===this._ws.readyState)this._ws.close();else{if(0===this._ws.readyState)return c.promise();if(1===this._ws.readyState)return c.resolve(this._ws),c.promise()}return this._ws=this._webSocket(a.extend(this._opt,{open:function(a){var b=this;c&&c.resolve(b)},close:function(a){c&&c.rejectWith(a)},message:function(a){for(var c=0,d=b._listeners.length;d>c;c++)try{b._listeners[c].deferred.notify.apply(b,[a])}catch(e){}},error:function(a){b._ws=null;for(var d=0,e=b._listeners.length;e>d;d++)b._listeners[d].deferred.reject.apply(b,[a]);c&&c.rejectWith.apply(b,[a])}})),c.promise()},_close:function(){this._ws&&(this._ws.close(),this._ws=null,this._reConnectDeferred=null)},_isConnected:function(){return null!==this._ws&&1===this._ws.readyState},_reConnect:function(){var b=this;return this._reConnectDeferred&&"pending"===this._reConnectDeferred.state()||(this._reConnectTries=this._prop(this._opt,"attempts",60),this._reConnectDeferred=a.Deferred()),this._ws&&1===this._ws.readyState?this._reConnectDeferred.resolve(this._ws):this._connect().done(function(){b._reConnectDeferred.resolve.apply(b,[b._ws])}).fail(function(a){b._reConnectTries--,b._reConnectTries>0?window.setTimeout(function(){b._reConnect.apply(b,[])},b._prop.apply(b,[b._opt,"timeout",1e4])):b._reConnectDeferred.rejectWith.apply(b,[a])}),b._reConnectDeferred.promise.apply(b,[])},_send:function(b){var c=this,d=a.Deferred();return function(a){c._reConnect.apply(c,[]).done(function(){c._ws.send(a),d.resolve.apply(c,[c._api])}).fail(function(a){d.rejectWith.apply(c,[a])})}(JSON.stringify(b)),d.promise()},_indexOfListener:function(a){for(var b=0,c=this._listeners.length;c>b;b++)if(this._listeners[b].listener===a)return b;return-1},_isNotEmpty:function(a,b){return"undefined"!=typeof a&&null!==a&&"undefined"!=typeof b&&null!==b&&""!==b&&"undefined"!=typeof a[b]&&null!==a[b]&&""!==a[b]},_prop:function(a,b,c){return this._isNotEmpty(a,b)?a[b]:c},_listen:function(b){var c=this,d=a.Deferred();return c._reConnect.apply(c,[]).done(function(){d.progress(function(){b.apply(this,arguments)}),c._remove.apply(c,[b]),c._listeners.push({deferred:d,listener:b})}).fail(function(a){d.reject(a)}),d.promise()},_listenReconnect:function(b){var c=a.Deferred(),d=this;return this._listen(b).fail(function(){c.progress(arguments),d._listenReconnect.apply(d,[b])}),c.promise()},_remove:function(a){var b=this._indexOfListener(a);-1!==b&&_listeners.splice(b,1)}},a.extend({simpleWebSocket:function(a){return new b(a)}})});